rm(list = ls()) # Para limpiar el entorno
# Paquetes requeridos
if(!require('pacman')) install.packages('pacman') 
pacman::p_load( 
  tidyverse, 
  janitor,
  readxl, # Para manipulación de datos y otras muchas funciones
  zip, # Para extracción de archivos zip
  readxl, # Para lectura de archivs excel
  htmltools, # Para agregar características html en el caso de mapas interactivos
  htmlwidgets, # Para guardar nuestro mapa como html
  rgdal, rgeos, # Para el manejo de archivos geográficos
  rcartocolor, # Paquete de paleta de colores
  leaflet,
  leaflegend)
  


 concentrado <- read_excel("Datos/Concentrado GDS_12.1.22.xlsx", 
                                      col_types = c("numeric", "text", "numeric", 
                                                    "text", "text", "text", "text", "text", 
                                                    "text", "text", "numeric", "numeric", 
                                                    "text", "text", "text", "text", "text", 
                                                    "date", "date", "date", "text", "text", 
                                                    "text", "text", "text", "text", "text", 
                                                    "text", "text", "text", "text", "text", 
                                                    "text", "text", "text", "text", "text", 
                                                    "text", "text", "text", "text", "text", 
                                                    "text", "text", "text", "text", "text", 
                                                    "text", "text", "text", "text", "text")) %>% 
  clean_names() %>% 
  remove_empty()

str(concentrado)


coberturas <- concentrado %>% 
  mutate(cobertura=str_trim(cobertura, side="right")) %>% 
  mutate(incendio=str_count(cobertura, "INCENDIO"),
         hctt_vf=str_count(cobertura, "H.C.T.T.VF"),
         granizo=str_count(cobertura, "GRANIZO"),
         inundacion=str_count(cobertura, "INUNDACION"),
         heladas=str_count(cobertura, "HELADAS"),
         fpc_maq=str_count(cobertura, "F.P.C.MAQ."),
         exc_hmdad=str_count(cobertura, "EXC.HMDAD."),
         bja_temper=str_count(cobertura, "BJA.TEMPER"),
         ond_calida=str_count(cobertura, "OND.CALIDA"),
         imp_siemb=str_count(cobertura, "IMP.SIEMB"),
         taponamto=str_count(cobertura, "TAPONAMTO."),
         no_nacenc=str_count(cobertura, "NO NACENC."),
         plag_y_dep=str_count(cobertura, "PLAG.Y DEP"),
         enfermedad=str_count(cobertura, "ENFERMEDAD"),
         codigo=poliza
         ) %>% separate(codigo, c("oficina", "cod1", "cod2"), "/") %>% 
  mutate(n_coberturas=incendio + hctt_vf + granizo + inundacion + heladas + 
                          fpc_maq + exc_hmdad + bja_temper + ond_calida + taponamto + 
                          no_nacenc + plag_y_dep + enfermedad) %>% filter(!is.na(suma_asegurada)) %>% 
  mutate(oficina= case_when(oficina=="4" ~ "Hermosillo",
                            oficina=="204" ~ "Culiacán",
                            oficina=="304" ~ "Cd.Obregón",
                            oficina=="154" ~ "Guasave",
                            oficina=="164" ~ "Los Mochis"),
         estado= case_when(
         municipio=="Hermosillo" ~ "Sonora", 
         municipio=="Culiacan" ~ "Sinaloa", 
         municipio=="Guasave" ~ "Sinaloa", 
         municipio== "Obregón" ~ "Sonora", 
         municipio=="Obregon" ~ "Sonora", 
         municipio=="Etchojoa" ~ "Sonora", 
         municipio== "Huatabampo" ~ "Sonora", 
         municipio=="Navojoa" ~ "Sonora", 
         municipio=="Cajeme"~ "Sonora", 
         municipio=="San Ignacio Río Muerto" ~ "Sonora", 
         municipio== "Bacum" ~ "Sonora", 
         municipio== "Navolato" ~ "Sinaloa", 
         municipio==   "Mocorito" ~ "Sinaloa", 
         municipio== "El Fuerte" ~ "Sinaloa", 
         municipio==  "Ahome" ~ "Sinaloa", 
         municipio== "Sinaloa de Leyva" ~ "Sinaloa", 
         municipio==  "Sinaloa" ~ "Sinaloa", 
         municipio== "Elota" ~ "Sinaloa", 
         municipio==  "Culiacán" ~ "Sinaloa", 
         municipio== "Salvador Alvarado" ~ "Sinaloa", 
         municipio=="Angostura" ~ "Sinaloa", 
         municipio== "Guaymas" ~ "Sonora", 
         municipio== "Mazatlan" ~ "Sinaloa", 
         municipio== "San Ignacio Rio Muerto" ~ "Sonora", 
         municipio=="San Ignacio" ~ "Sinaloa", 
         municipio==  "Benito Juarez" ~ "Sonora", 
         municipio== "HUATABAMPO" ~ "Sonora", 
         municipio== "ETCHOJOA" ~ "Sonora", 
         municipio==  "CAJEME" ~ "Sonora"),
         municipio= case_when(
           municipio=="Hermosillo" ~ "Hermosillo", 
           municipio=="Culiacan" ~ "Culiacán", 
           municipio=="Guasave" ~ "Guasave", 
           municipio== "Obregón" ~ "Cajeme", 
           municipio=="Obregon" ~ "Cajeme", 
           municipio=="Etchojoa" ~ "Etchojoa", 
           municipio== "Huatabampo" ~ "Huatabampo", 
           municipio=="Navojoa" ~ "Navojoa", 
           municipio=="Cajeme"~ "Cajeme", 
           municipio=="San Ignacio Río Muerto" ~ "San Ignacio Río Muerto", 
           municipio== "Bacum" ~ "Bácum", 
           municipio== "Navolato" ~ "Novolato", 
           municipio==   "Mocorito" ~ "Mocorito", 
           municipio== "El Fuerte" ~ "El Fuerte", 
           municipio==  "Ahome" ~ "Ahome", 
           municipio== "Sinaloa de Leyva" ~ "Sinaloa de Leyva", 
           municipio==  "Sinaloa" ~ "Sinaloa de Leyva", 
           municipio== "Elota" ~ "Elota", 
           municipio==  "Culiacán" ~ "Culiacán", 
           municipio== "Salvador Alvarado" ~ "Salvador Alvarado", 
           municipio=="Angostura" ~ "Angostura", 
           municipio== "Guaymas" ~ "Guaymas", 
           municipio== "Mazatlan" ~ "Mazatlán", 
           municipio== "San Ignacio Rio Muerto" ~ "San Ignacio Río Muerto", 
           municipio=="San Ignacio" ~ "San Ignacio", 
           municipio==  "Benito Juarez" ~ "Benito Juárez", 
           municipio== "HUATABAMPO" ~ "Huatabampo", 
           municipio== "ETCHOJOA" ~ "Etchojoa", 
           municipio==  "CAJEME" ~ "Cajeme")) %>% 
  mutate(concat= case_when(
    municipio== "Hermosillo"~ "26030", 
    municipio== "Culiacán"~ "25006", 
    municipio=="Guasave" ~ "25011" , 
    municipio== "Cajeme"~ "26018", 
    municipio=="Etchojoa"~ "26026", 
    municipio== "Huatabampo"~ "26033", 
    municipio=="Navojoa"~ "26042", 
    municipio=="San Ignacio Río Muerto"~ "26072", 
    municipio== "Bácum"~ "26012", 
    municipio== "Novolato"~ "25018", 
    municipio== "Mocorito"~ "25013", 
    municipio==  "El Fuerte"~ "25010", 
    municipio==  "Ahome"~ "25001", 
    municipio==  "Sinaloa de Leyva"~ "25017", 
    municipio== "Elota"~ "25008", 
    municipio==  "Culiacán"~ "25006", 
    municipio== "Salvador Alvarado"~ "25015", 
    municipio=="Angostura"~ "25002", 
    municipio== "Guaymas"~ "26029", 
    municipio== "Mazatlán"~ "25012", 
    municipio==  "Benito Juarez" ~ "26071",
    municipio==  "San Ignacio" ~ "25016"),
    maiz=if_else(cultivo=="Maíz", 1,0),                      
                   trigo=if_else(cultivo=="Trigo", 1,0),                       
                   frijol=if_else(cultivo=="Frijol", 1,0),                     
                   maiz_dulce=if_else(cultivo=="Maíz Dulce", 1,0),                 
                   maiz_elotero=if_else(cultivo=="Maíz Elotero", 1,0),
                   calabaza_delicata=if_else(cultivo=="Calabaza Delicata", 1,0),
                   calabaza_winter_melon=if_else(cultivo=="Calabaza Winter Melon", 1,0),
                   calabaza_spaghetti=if_else(cultivo=="Calabaza Spaguetti", 1,0),
                   calabaza_banana_squash=if_else(cultivo== "Calabaza Banana Squash", 1,0),
                   calabaza_long_island_cheese=if_else(cultivo=="Calabaza Long Island Cheese", 1,0),
  OI_2021_2022=if_else(ciclo=="OI 2021-2022", 1,0),
  OI_2021_2023=if_else(ciclo=="OI 2021-2023", 1,0),
  OI_2021_2024=if_else(ciclo=="OI 2021-2024", 1,0),
  OI_2021_2025=if_else(ciclo=="OI 2021-2025", 1,0))

  polizas <- coberturas %>% 
  group_by(concat, estado, oficina,  poliza, id_solicitud,
           municipio, tipo_de_persona, asegurado, suma_asegurada,
           beneficiario_preferente, siniestro,
           incendio, hctt_vf, granizo, inundacion, heladas,  
           fpc_maq, exc_hmdad, bja_temper, ond_calida, taponamto,  
           no_nacenc, plag_y_dep, enfermedad,n_coberturas) %>% 
  summarise(n_lotes=length(lote), sum_superficie=sum(superficie),
            maiz=sum(maiz),                       
            trigo=sum(trigo),                       
            frijol=sum(frijol),                     
            maiz_dulce=sum(maiz_dulce),                 
            maiz_elotero=sum(maiz_elotero),
            calabaza_delicata=sum(calabaza_delicata),
            calabaza_winter_melon=sum(calabaza_winter_melon),
            calabaza_spaghetti=sum(calabaza_spaghetti),
            calabaza_banana_Squash=sum(calabaza_banana_squash),
            calabaza_long_island_cheese=sum(calabaza_long_island_cheese),
            OI_2021_2022=sum(OI_2021_2022),
            OI_2021_2023=sum(OI_2021_2023),
            OI_2021_2024=sum(OI_2021_2024),
            OI_2021_2025=sum(OI_2021_2025)
            )%>% 
  mutate(sum_aseg_total=suma_asegurada*sum_superficie, sup_prom_lote=round(sum_superficie/n_lotes,1)) %>% 
  mutate(sum_aseg_prom_lote=round(sum_aseg_total/n_lotes,1)) %>% ungroup() %>% 
  select(oficina,  poliza, id_solicitud, concat, estado,
         municipio, tipo_de_persona, asegurado,beneficiario_preferente, 
         sum_superficie,
         sum_aseg_total, sup_prom_lote, sum_aseg_prom_lote,
         incendio, hctt_vf, granizo, inundacion, heladas,  
         fpc_maq, exc_hmdad, bja_temper, ond_calida, taponamto,  
         no_nacenc, plag_y_dep, enfermedad,n_coberturas, siniestro, maiz,                       
         trigo,                       
         frijol,                     
         maiz_dulce,                 
         maiz_elotero,
         calabaza_delicata,
         calabaza_winter_melon,
         calabaza_spaghetti,
         calabaza_banana_Squash,
         calabaza_long_island_cheese,
         OI_2021_2022,
         OI_2021_2023,
         OI_2021_2024,
         OI_2021_2025)

  
  

write.csv(polizas, "Resultado/polizas.csv", row.names = FALSE)



agrupado <- coberturas %>% 
  group_by(concat, estado, poliza, 
           municipio, suma_asegurada,
           siniestro) %>% 
  summarise(n_lotes=length(unique(lote)), sum_superficie=sum(superficie),
              )%>% 
  mutate(sum_aseg_total=suma_asegurada*sum_superficie, sup_prom_lote=round(sum_superficie/n_lotes,1)) %>% 
  mutate(sum_aseg_prom_lote=round(sum_aseg_total/n_lotes,1)) %>% ungroup() %>% 
  select(poliza,  concat, estado,
         municipio
         )


municipios <- coberturas %>% filter(!is.na(superficie), !is.na(suma_asegurada)) %>% 
  group_by(concat, estado, municipio) %>% 
  summarise(n_polizas=length(unique(poliza)), n_lotes=length(lote), sum_aseg_total=sum(suma_asegurada*superficie),
            suma_superficie=sum(superficie),
            maiz=sum(maiz),                       
            trigo=sum(trigo),                       
            frijol=sum(frijol),                     
            maiz_dulce=sum(maiz_dulce),                 
            maiz_elotero=sum(maiz_elotero),
            calabaza_delicata=sum(calabaza_delicata),
            calabaza_winter_melon=sum(calabaza_winter_melon),
            calabaza_spaghetti=sum(calabaza_spaghetti),
            calabaza_banana_Squash=sum(calabaza_banana_squash),
            calabaza_long_island_cheese=sum(calabaza_long_island_cheese), n_coberturas=sum(n_coberturas)) %>% 
  mutate(suma_asegurada_sup=sum_aseg_total/suma_superficie,
         superficie_poliza=suma_superficie/n_polizas,
         suma_asegurada_poliza=sum_aseg_total/n_polizas,
         superficie_lote=suma_superficie/n_lotes,
         suma_asegurada_lote=sum_aseg_total/n_lotes)



oficina <- coberturas %>% filter(!is.na(superficie), !is.na(suma_asegurada)) %>% 
  group_by(oficina) %>% 
  summarise(n_polizas=length(unique(poliza)), n_lotes=length(lote), sum_aseg_total=sum(suma_asegurada*superficie),
            suma_superficie=sum(superficie),
            maiz=sum(maiz),                       
            trigo=sum(trigo),                       
            frijol=sum(frijol),                     
            maiz_dulce=sum(maiz_dulce),                 
            maiz_elotero=sum(maiz_elotero),
            calabaza_delicata=sum(calabaza_delicata),
            calabaza_winter_melon=sum(calabaza_winter_melon),
            calabaza_spaghetti=sum(calabaza_spaghetti),
            calabaza_banana_Squash=sum(calabaza_banana_squash),
            calabaza_long_island_cheese=sum(calabaza_long_island_cheese), n_coberturas=sum(n_coberturas)) %>% 
  mutate(suma_asegurada_sup=sum_aseg_total/suma_superficie,
          superficie_poliza=suma_superficie/n_polizas,
         suma_asegurada_poliza=sum_aseg_total/n_polizas,
         superficie_lote=suma_superficie/n_lotes,
         suma_asegurada_lote=sum_aseg_total/n_lotes)


capa_sinson<- readOGR("Capas", layer="SINSON",  encoding = "UTF-8", use_iconv=TRUE)

capa_sinson<- spTransform(capa_sinson, 
                        CRS("+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0"))
capa_sinson <- capa_sinson %>%  merge(municipios)
capa_sinson <- capa_sinson[!is.na(capa_sinson@data$sum_aseg_total),]

palnumeric <- colorNumeric(carto_pal(7,"Purp"), domain = capa_sinson$sum_aseg_total)

popup <- paste0(
  "<b>", as.character(capa_sinson$NOM_MUN), ", ",as.character(capa_sinson$estado),"</b>",     "<br>",
  "<b>", "No. Pólizas:   ", "</b>",   capa_sinson$n_polizas,      "<br>",
  "<b>", "No. Lotes:   ",           "</b>",   as.character(capa_sinson$n_lotes),      "<br>",
  "<b>", "Monto asegurado total:   ",           "</b>", "$",  prettyNum(as.numeric(capa_sinson$sum_aseg_total), big.mark=",", preserve.width="none"),      "<br>",
  "<b>", "Superficie total:   ",           "</b>",   prettyNum(as.numeric(capa_sinson$suma_superficie),big.mark=",", preserve.width="none"), " ha.",      "<br>",
  "<b>", "Monto asegurado promedio por póliza:   ",           "</b>", "$",  prettyNum(as.numeric(capa_sinson$suma_asegurada_poliza), big.mark=",", preserve.width="none"),      "<br>",
  "<b>", "Superficie promedio por lote:   ",           "</b>",  prettyNum(as.numeric(capa_sinson$superficie_lote), big.mark=",", preserve.width="none")," ha.",      "<br>")  %>%
  lapply(htmltools::HTML)

label <- paste0(
  "<b>", as.character(capa_sinson$NOM_MUN), ", ",as.character(capa_sinson$estado),"</b>")  %>%
  lapply(htmltools::HTML)


mapasinecta <- leaflet(capa_sinson) %>% 
  addProviderTiles(providers$CartoDB.DarkMatter) %>%
  addPolygons(data= capa_sinson,
              stroke= TRUE,
              weight=1,                   
              opacity=1,
              fillColor = ~palnumeric(capa_sinson$sum_aseg_total),
              color= "white",
              fillOpacity = 1,
              smoothFactor = 0.5,
              highlightOptions = highlightOptions(color = "black", 
                                                  weight = 1.2,
                                                  bringToFront = TRUE),
              label=label, 
              labelOptions = labelOptions(noHide = F, direction = "top",
                                          style = list(
                                            "color" = "black",
                                            "font-family" = "Arial",
                                            "font-style" = "bold",
                                            "box-shadow" = "2px 2px rgba(0,0,0,0.25)",
                                            "font-size" = "15px",
                                            "border-color" = "rgba(0,0,0,0.5)"
                                          )),
              popup=popup, 
              popupOptions = labelOptions(noHide = F, direction = "top",
                                          style = list(
                                            "color" = "black",
                                            "font-family" = "Arial",
                                            "font-style" = "regular",
                                            "box-shadow" = "2px 2px rgba(0,0,0,0.25)",
                                            "font-size" = "11px",
                                            "border-color" = "rgba(0,0,0,0.5)"
                                          )),
              group= "Monto asegurado total") %>%
  addLegend(position = "bottomleft", pal = palnumeric, values = ~capa_sinson$sum_aseg_total, opacity=1, group= "Suma asegurada total", 
            title = "Monto asegurado total",  labFormat = labelFormat(prefix = "$"), na.label = "N/A") 
mapasinecta

saveWidget(mapasinecta,"sinecta.html", selfcontained = T, libdir = "lib", title= "Monto asegurado total por municipio")

